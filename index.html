<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ATM Manager - Bank Sulselbar</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            /* Updated Color Palette */
            --primary-color: #99bb1c;
            --secondary-color: #023259;
            --primary-gradient: linear-gradient(135deg, #99bb1c 0%, #7a9516 100%);
            --secondary-gradient: linear-gradient(135deg, #023259 0%, #034a7b 100%);
            --success-gradient: linear-gradient(135deg, #99bb1c 0%, #7a9516 100%);
            --warning-gradient: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --bg-light: #f8fafc;
            --bg-dark: #1a1a2e;
            --card-shadow: 0 8px 25px rgba(0,0,0,0.08);
            --hover-shadow: 0 15px 35px rgba(0,0,0,0.15);
            --mobile-padding: 16px;
            --mobile-radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            height: 100%;
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        body {
            background: var(--bg-light);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #2d3748;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-tap-highlight-color: transparent;
            -webkit-overflow-scrolling: touch;
        }

        body.dark-mode {
            --bg-light: #1a1a2e;
            --bg-dark: #0f0f1e;
            background: var(--bg-dark);
            color: #e2e8f0;
        }

        /* Mobile Container - Fixed scroll issues */
        .mobile-container {
            max-width: 100%;
            margin: 0;
            padding: var(--mobile-padding);
            min-height: calc(100vh - 80px);
            padding-bottom: 100px;
            position: relative;
        }

        /* Header Section - Mobile Optimized */
        .mobile-header {
            background: var(--secondary-gradient);
            color: white;
            padding: 20px var(--mobile-padding);
            margin: calc(-1 * var(--mobile-padding)) calc(-1 * var(--mobile-padding)) 20px calc(-1 * var(--mobile-padding));
            border-radius: 0 0 24px 24px;
            position: relative;
            box-shadow: 0 4px 20px rgba(2, 50, 89, 0.3);
        }

        .mobile-header h1 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .mobile-header p {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 12px;
        }

        .header-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .header-badges .badge {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 11px;
            backdrop-filter: blur(10px);
        }

        /* Stats Cards - Mobile Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: var(--mobile-radius);
            padding: 16px;
            box-shadow: var(--card-shadow);
            text-align: center;
            position: relative;
            transition: all 0.2s ease;
            border-top: 3px solid var(--primary-color);
        }

        .stat-card:active {
            transform: scale(0.98);
        }

        body.dark-mode .stat-card {
            background: rgba(45, 55, 72, 0.9);
            color: #e2e8f0;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin: 0 auto 8px;
            color: white;
        }

        .stat-card.primary .stat-icon { background: var(--primary-gradient); }
        .stat-card.secondary .stat-icon { background: var(--secondary-gradient); }
        .stat-card.success .stat-icon { background: var(--success-gradient); }
        .stat-card.warning .stat-icon { background: var(--warning-gradient); }
        .stat-card.danger .stat-icon { background: var(--danger-gradient); }
        .stat-card.info .stat-icon { background: var(--info-gradient); }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--secondary-color);
        }

        body.dark-mode .stat-number {
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 11px;
            color: #64748b;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.dark-mode .stat-label {
            color: #94a3b8;
        }

        /* Search Section */
        .search-section {
            background: white;
            border-radius: var(--mobile-radius);
            padding: var(--mobile-padding);
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }

        body.dark-mode .search-section {
            background: rgba(45, 55, 72, 0.9);
        }

        .search-input {
            position: relative;
        }

        .search-input input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            background: #f8fafc;
            transition: all 0.2s ease;
        }

        .search-input input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(153, 187, 28, 0.1);
        }

        .search-input i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
        }

        .filter-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .filter-select {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 12px;
            background: #f8fafc;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* ATM Cards - Mobile Optimized */
        .atm-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 20px;
        }

        .atm-card {
            background: white;
            border-radius: var(--mobile-radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: all 0.2s ease;
            position: relative;
        }

        .atm-card:active {
            transform: scale(0.99);
        }

        body.dark-mode .atm-card {
            background: rgba(45, 55, 72, 0.9);
        }

        .atm-card-header {
            background: var(--secondary-gradient);
            color: white;
            padding: 16px;
            position: relative;
        }

        .atm-status {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .atm-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            padding-right: 60px;
        }

        .atm-address {
            font-size: 12px;
            opacity: 0.9;
            line-height: 1.4;
        }

        .atm-card-body {
            padding: 16px;
        }

        /* AC Info Section */
        .ac-info {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
            border-left: 4px solid var(--primary-color);
        }

        body.dark-mode .ac-info {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        }

        .ac-info::before {
            content: '❄️';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 30px;
            opacity: 0.2;
        }

        .ac-info h6 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--secondary-color);
        }

        body.dark-mode .ac-info h6 {
            color: var(--primary-color);
        }

        .ac-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .ac-item {
            background: rgba(255, 255, 255, 0.7);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        body.dark-mode .ac-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ac-label {
            font-size: 10px;
            color: #718096;
            text-transform: uppercase;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .ac-value {
            font-size: 12px;
            font-weight: 600;
            color: var(--secondary-color);
        }

        body.dark-mode .ac-value {
            color: #e2e8f0;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .action-btn {
            flex: 1;
            padding: 10px 8px;
            border: none;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-height: 40px;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .btn-history {
            background: var(--info-gradient);
            color: white;
        }

        .btn-edit {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-delete {
            background: var(--danger-gradient);
            color: white;
        }

        /* Charts Section */
        .charts-section {
            background: white;
            border-radius: var(--mobile-radius);
            padding: var(--mobile-padding);
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            display: none;
        }

        body.dark-mode .charts-section {
            background: rgba(45, 55, 72, 0.9);
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--card-shadow);
            position: relative;
        }

        body.dark-mode .chart-container {
            background: rgba(45, 55, 72, 0.9);
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 12px;
            text-align: center;
        }

        body.dark-mode .chart-title {
            color: var(--primary-color);
        }

        .chart-canvas {
            position: relative;
            height: 250px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e2e8f0;
            padding: 8px 0;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(20px);
        }

        body.dark-mode .bottom-nav {
            background: rgba(45, 55, 72, 0.95);
            border-top: 1px solid #4a5568;
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
            max-width: 100%;
            margin: 0 auto;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            text-decoration: none;
            color: #64748b;
            font-size: 10px;
            font-weight: 500;
            transition: all 0.2s ease;
            border-radius: 12px;
            min-width: 60px;
        }

        .nav-item:hover, .nav-item.active {
            color: var(--primary-color);
            background: rgba(153, 187, 28, 0.1);
            text-decoration: none;
        }

        .nav-item i {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .nav-item.add-btn {
            background: var(--primary-gradient);
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            position: relative;
            top: -8px;
            box-shadow: 0 4px 20px rgba(153, 187, 28, 0.4);
        }

        .nav-item.add-btn i {
            font-size: 24px;
            margin-bottom: 0;
        }

        /* Dark Mode Toggle */
        .dark-toggle {
            position: fixed;
            top: 20px;
            right: var(--mobile-padding);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 16px;
            z-index: 1001;
            transition: all 0.2s ease;
        }

        .dark-toggle:active {
            transform: scale(0.9);
        }

        /* Modal Adjustments for Mobile */
        .modal-content {
            margin: 20px;
            border-radius: 20px;
            border: none;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            background: var(--secondary-gradient);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-body {
            padding: 20px;
            max-height: calc(85vh - 120px);
            overflow-y: auto;
        }

        .form-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.dark-mode .form-label {
            color: var(--primary-color);
        }

        .form-control, .form-select {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 14px;
            background: #f8fafc;
            transition: all 0.2s ease;
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(153, 187, 28, 0.1);
        }

        .btn-primary {
            background: var(--primary-gradient);
            border: none;
        }

        .btn-secondary {
            background: var(--secondary-gradient);
            border: none;
        }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 80px;
            left: var(--mobile-padding);
            right: var(--mobile-padding);
            z-index: 2000;
            pointer-events: none;
        }

        .custom-toast {
            background: white;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            animation: slideDown 0.3s ease;
            pointer-events: auto;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .toast-success .toast-icon {
            background: var(--success-gradient);
            color: white;
        }

        .toast-error .toast-icon {
            background: var(--danger-gradient);
            color: white;
        }

        .toast-warning .toast-icon {
            background: var(--warning-gradient);
            color: white;
        }

        .toast-info .toast-icon {
            background: var(--info-gradient);
            color: white;
        }

        /* History Items */
        .history-item {
            background: #f8fafc;
            border-radius: 10px;
            padding: 12px;
            margin: 8px 0;
            border-left: 3px solid var(--primary-color);
            position: relative;
        }

        body.dark-mode .history-item {
            background: rgba(45, 55, 72, 0.5);
        }

        .history-meta {
            font-size: 11px;
            color: #718096;
            margin-bottom: 4px;
        }

        .history-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .history-text {
            font-size: 13px;
            color: var(--secondary-color);
            flex: 1;
        }

        body.dark-mode .history-text {
            color: #e2e8f0;
        }

        .history-delete {
            background: none;
            border: none;
            color: #e53e3e;
            padding: 4px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .history-delete:hover {
            background: rgba(229, 62, 62, 0.1);
        }

        /* Responsive Adjustments */
        @media (max-width: 480px) {
            :root {
                --mobile-padding: 12px;
            }

            .mobile-header {
                padding: 16px var(--mobile-padding);
            }

            .stats-grid {
                gap: 8px;
            }

            .atm-grid {
                gap: 12px;
            }

            .modal-content {
                margin: 10px;
            }
        }

        @media (max-width: 360px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .filter-row {
                flex-direction: column;
            }

            .ac-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Landscape mode adjustments */
        @media (orientation: landscape) and (max-height: 500px) {
            .mobile-header {
                padding: 12px var(--mobile-padding);
            }
            
            .mobile-header h1 {
                font-size: 16px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Print styles */
        @media print {
            .bottom-nav,
            .dark-toggle {
                display: none !important;
            }
        }

        /* Scroll improvements */
        .mobile-container {
            scroll-padding-top: 20px;
        }

        /* Ensure proper scrolling on all devices */
        body {
            position: relative;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Mobile Container -->
    <div class="mobile-container">
        <!-- Header Section -->
        <div class="mobile-header">
            <h1><i class="fas fa-university me-2"></i>ATM Manager</h1>
            <p>Bank Sulselbar - KCU Makassar</p>
            <div class="header-badges">
                <span class="badge" id="firebaseStatus">
                    <i class="fas fa-cloud-check me-1"></i>Connected
                </span>
                <span class="badge" id="lastUpdate">
                    <i class="fas fa-clock me-1"></i>Just now
                </span>
            </div>
        </div>

        <!-- Dark Mode Toggle -->
        <button class="dark-toggle" onclick="toggleDarkMode()">
            <i class="fas fa-moon" id="darkModeIcon"></i>
        </button>

        <!-- Statistics Grid -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-icon">
                    <i class="fas fa-university"></i>
                </div>
                <div class="stat-number" id="totalATM">0</div>
                <div class="stat-label">Total ATM</div>
            </div>
            <div class="stat-card success">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-number" id="activeATM">0</div>
                <div class="stat-label">Active</div>
            </div>
            <div class="stat-card info">
                <div class="stat-icon">
                    <i class="fas fa-snowflake"></i>
                </div>
                <div class="stat-number" id="acWorking">0</div>
                <div class="stat-label">AC OK</div>
            </div>
            <div class="stat-card danger">
                <div class="stat-icon">
                    <i class="fas fa-tools"></i>
                </div>
                <div class="stat-number" id="needMaintenance">0</div>
                <div class="stat-label">Need Service</div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="search-input">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search ATM...">
            </div>
            <div class="filter-row">
                <select class="filter-select" id="filterStatus">
                    <option value="">All Status</option>
                    <option value="aktif">Active</option>
                    <option value="maintenance">Maintenance</option>
                    <option value="tidak_aktif">Inactive</option>
                </select>
                <select class="filter-select" id="filterAC">
                    <option value="">All AC</option>
                    <option value="baik">Good</option>
                    <option value="perlu_service">Need Service</option>
                    <option value="rusak">Broken</option>
                </select>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section" id="chartsSection">
            <div class="chart-container">
                <div class="chart-title">ATM Status Overview</div>
                <div class="chart-canvas">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">AC Condition Analysis</div>
                <div class="chart-canvas">
                    <canvas id="acChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Monthly Maintenance Trend</div>
                <div class="chart-canvas">
                    <canvas id="maintenanceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Loading ATM data...</p>
        </div>

        <!-- ATM Grid -->
        <div class="atm-grid" id="atmList">
            <!-- ATM cards will be populated here -->
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-items">
            <a href="#" class="nav-item active" onclick="setActiveNav(this, 'home')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item" onclick="setActiveNav(this, 'charts'); toggleCharts()">
                <i class="fas fa-chart-pie"></i>
                <span>Charts</span>
            </a>
            <a href="#" class="nav-item add-btn" onclick="openATMModal()">
                <i class="fas fa-plus"></i>
            </a>
            <a href="#" class="nav-item" onclick="setActiveNav(this, 'export'); exportData()">
                <i class="fas fa-download"></i>
                <span>Export</span>
            </a>
            <a href="#" class="nav-item" onclick="setActiveNav(this, 'settings'); showSettings()">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </div>
    </div>

    <!-- ATM Modal -->
    <div class="modal fade" id="atmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">
                        <i class="fas fa-university me-2"></i>Add New ATM
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="atmForm">
                        <input type="hidden" id="atmId">
                        
                        <!-- Basic Info -->
                        <div class="mb-3">
                            <label class="form-label">ATM Name</label>
                            <input type="text" class="form-control" id="atmName" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" id="atmAddress" rows="3" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ATM Status</label>
                            <select class="form-select" id="atmStatus">
                                <option value="aktif">Active</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="tidak_aktif">Inactive</option>
                            </select>
                        </div>

                        <!-- AC Info -->
                        <hr>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">AC Brand</label>
                                <input type="text" class="form-control" id="acBrand">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Capacity (PK)</label>
                                <input type="number" class="form-control" id="acCapacity" step="0.5">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">AC Status</label>
                                <select class="form-select" id="acStatus">
                                    <option value="baik">Good</option>
                                    <option value="perlu_service">Need Service</option>
                                    <option value="rusak">Broken</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Temperature (°C)</label>
                                <input type="number" class="form-control" id="acTemp" min="16" max="30" value="24">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Last Technician</label>
                            <input type="text" class="form-control" id="lastTechnician">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">AC Notes</label>
                            <textarea class="form-control" id="acNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveATM()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-history me-2"></i>Maintenance History
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Add History Form -->
                    <div class="card mb-3" style="border: none; background: #f8fafc; border-radius: 12px;">
                        <div class="card-body p-3">
                            <div class="row mb-2">
                                <div class="col-12 mb-2">
                                    <input type="text" class="form-control" id="technicianName" 
                                           placeholder="Technician name">
                                </div>
                                <div class="col-12">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="newHistoryEntry" 
                                               placeholder="Work description...">
                                        <button class="btn btn-primary" onclick="addHistoryEntry()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- History List -->
                    <div id="historyList">
                        <!-- History items will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCrpljw48aAYyzsbMqUePgFSDOX-klsCAc",
            authDomain: "atmbanksulselbar.firebaseapp.com",
            projectId: "atmbanksulselbar",
            storageBucket: "atmbanksulselbar.firebasestorage.app",
            messagingSenderId: "261036476120",
            appId: "1:261036476120:web:a5f1598883d3e4b35c79ad"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
    </script>

    <script>
        // Global Variables
        let atmData = [];
        let currentATMId = null;
        let unsubscribe = null;
        let darkMode = false;
        let charts = {
            status: null,
            ac: null,
            maintenance: null
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing Mobile ATM Management...');
            
            // Check for saved dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                toggleDarkMode();
            }
            
            // Initialize Firebase
            setTimeout(() => {
                loadATMDataFromFirebase();
                setupRealtimeListener();
            }, 1000);
            
            setupEventListeners();
            
            // Initialize Chart.js defaults for mobile
            Chart.defaults.font.size = 12;
            Chart.defaults.responsive = true;
            Chart.defaults.maintainAspectRatio = false;
        });

        // Setup Event Listeners
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterATMs);
            document.getElementById('filterStatus').addEventListener('change', filterATMs);
            document.getElementById('filterAC').addEventListener('change', filterATMs);

            // Modal cleanup
            document.getElementById('atmModal').addEventListener('hidden.bs.modal', function() {
                currentATMId = null;
                document.getElementById('atmForm').reset();
            });

            // History modal enter key support
            document.getElementById('newHistoryEntry').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addHistoryEntry();
                }
            });

            document.getElementById('technicianName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('newHistoryEntry').focus();
                }
            });

            // Prevent zoom on input focus (iOS)
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    if (window.innerWidth < 768) {
                        document.querySelector('meta[name="viewport"]').setAttribute('content', 'width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0');
                    }
                });
                input.addEventListener('blur', function() {
                    if (window.innerWidth < 768) {
                        document.querySelector('meta[name="viewport"]').setAttribute('content', 'width=device-width, initial-scale=1.0, user-scalable=no');
                    }
                });
            });
        }

        // Setup Realtime Listener
        function setupRealtimeListener() {
            if (unsubscribe) unsubscribe();
            
            updateConnectionStatus('syncing');
            
            unsubscribe = window.onSnapshot(window.collection(window.db, "atms"), (snapshot) => {
                atmData = [];
                snapshot.forEach((doc) => {
                    atmData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderATMs();
                updateStatistics();
                updateCharts();
                updateConnectionStatus('connected');
                updateLastUpdateTime();
            }, (error) => {
                console.error("Error in real-time listener:", error);
                updateConnectionStatus('error');
                showToast('error', 'Connection error');
            });
        }

        // Load ATM Data from Firebase
        async function loadATMDataFromFirebase() {
            document.getElementById('loading').style.display = 'flex';
            
            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, "atms"));
                atmData = [];
                
                if (querySnapshot.empty) {
                    await addSampleData();
                } else {
                    querySnapshot.forEach((doc) => {
                        atmData.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                }
                
                renderATMs();
                updateStatistics();
                updateCharts();
                showToast('success', 'Data loaded successfully');
            } catch (error) {
                console.error("Error loading ATM data:", error);
                showToast('error', 'Failed to load data');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Add Sample Data
        async function addSampleData() {
            const sampleData = [
                {
                    name: "ATM Cabang Utama Makassar",
                    address: "Jl. DR. Ratulangi No. 16, Kel. Mangkura, Kec. Ujung Pandang, Kota Makassar",
                    status: "aktif",
                    acBrand: "Daikin",
                    acCapacity: 2,
                    acStatus: "baik",
                    acTemp: 24,
                    lastTechnician: "Budi Santoso",
                    acNotes: "AC working properly",
                    history: [
                        { 
                            date: "2024-12-15", 
                            entry: "Regular AC maintenance",
                            technician: "Budi Santoso"
                        },
                        { 
                            date: "2024-11-20", 
                            entry: "Filter cleaning",
                            technician: "Ahmad Rifai"
                        }
                    ],
                    createdAt: new Date().toISOString()
                },
                {
                    name: "ATM Drive Thru KONI Sulsel",
                    address: "Jl. Sultan Hasanuddin No. 42, Kel. Sawerigading, Kec. Ujung Pandang, Kota Makassar",
                    status: "aktif",
                    acBrand: "LG",
                    acCapacity: 1.5,
                    acStatus: "perlu_service",
                    acTemp: 26,
                    lastTechnician: "Rizki Pratama",
                    acNotes: "AC not cooling properly",
                    history: [
                        { 
                            date: "2024-10-10", 
                            entry: "Last AC service",
                            technician: "Rizki Pratama"
                        },
                        { 
                            date: "2024-12-20", 
                            entry: "Reported cooling issue",
                            technician: "Security Staff"
                        }
                    ],
                    createdAt: new Date().toISOString()
                },
                {
                    name: "ATM Mall Panakkukang",
                    address: "Jl. Boulevard Panakkukang, Panakkukang, Makassar",
                    status: "maintenance",
                    acBrand: "Panasonic",
                    acCapacity: 1.5,
                    acStatus: "rusak",
                    acTemp: 28,
                    lastTechnician: "Sari Dewi",
                    acNotes: "AC kompressor rusak",
                    history: [
                        { 
                            date: "2024-12-18", 
                            entry: "AC kompressor replacement needed",
                            technician: "Sari Dewi"
                        }
                    ],
                    createdAt: new Date().toISOString()
                }
            ];

            for (const atm of sampleData) {
                await window.addDoc(window.collection(window.db, "atms"), atm);
            }
        }

        // Render ATMs
        function renderATMs(data = atmData) {
            const atmList = document.getElementById('atmList');
            atmList.innerHTML = '';

            const filteredData = data.filter(atm => {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const statusFilter = document.getElementById('filterStatus').value;
                const acFilter = document.getElementById('filterAC').value;

                const matchSearch = !searchTerm || 
                    atm.name.toLowerCase().includes(searchTerm) ||
                    atm.address.toLowerCase().includes(searchTerm) ||
                    (atm.lastTechnician && atm.lastTechnician.toLowerCase().includes(searchTerm));

                const matchStatus = !statusFilter || atm.status === statusFilter;
                const matchAC = !acFilter || atm.acStatus === acFilter;

                return matchSearch && matchStatus && matchAC;
            });

            if (filteredData.length === 0) {
                atmList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <i class="fas fa-search" style="font-size: 48px; color: #cbd5e0; margin-bottom: 16px;"></i>
                        <h5 style="color: #718096; margin-bottom: 8px;">No ATMs found</h5>
                        <p style="color: #a0aec0; font-size: 14px;">Try adjusting your search or filters</p>
                    </div>
                `;
                return;
            }

            filteredData.forEach(atm => {
                const statusLabels = {
                    'aktif': 'ACTIVE',
                    'maintenance': 'MAINTENANCE',
                    'tidak_aktif': 'INACTIVE'
                };

                const acStatusLabels = {
                    'baik': 'Good',
                    'perlu_service': 'Need Service',
                    'rusak': 'Broken'
                };

                const acStatusColors = {
                    'baik': '#99bb1c',
                    'perlu_service': '#f6d365',
                    'rusak': '#ff6b6b'
                };

                const card = document.createElement('div');
                card.className = 'atm-card';
                card.innerHTML = `
                    <div class="atm-card-header">
                        <div class="atm-status">${statusLabels[atm.status]}</div>
                        <div class="atm-name">${atm.name}</div>
                        <div class="atm-address">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            ${atm.address.length > 80 ? atm.address.substring(0, 80) + '...' : atm.address}
                        </div>
                    </div>
                    <div class="atm-card-body">
                        <div class="ac-info">
                            <h6><i class="fas fa-snowflake me-1"></i>AC Information</h6>
                            <div class="ac-grid">
                                <div class="ac-item">
                                    <div class="ac-label">Brand</div>
                                    <div class="ac-value">${atm.acBrand || 'N/A'}</div>
                                </div>
                                <div class="ac-item">
                                    <div class="ac-label">Capacity</div>
                                    <div class="ac-value">${atm.acCapacity || 'N/A'} PK</div>
                                </div>
                                <div class="ac-item">
                                    <div class="ac-label">Status</div>
                                    <div class="ac-value" style="color: ${acStatusColors[atm.acStatus]}">
                                        ${acStatusLabels[atm.acStatus]}
                                    </div>
                                </div>
                                <div class="ac-item">
                                    <div class="ac-label">Temp</div>
                                    <div class="ac-value">${atm.acTemp || 24}°C</div>
                                </div>
                            </div>
                            ${atm.lastTechnician ? `
                                <div style="margin-top: 8px; font-size: 11px; color: #718096;">
                                    <i class="fas fa-user-cog me-1"></i>Last: ${atm.lastTechnician}
                                </div>
                            ` : ''}
                            ${atm.history && atm.history.length > 0 ? `
                                <div style="margin-top: 8px; font-size: 11px; color: var(--primary-color);">
                                    <i class="fas fa-history me-1"></i>${atm.history.length} maintenance record${atm.history.length !== 1 ? 's' : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn btn-history" onclick="viewHistory('${atm.id}')">
                                <i class="fas fa-history"></i>History
                            </button>
                            <button class="action-btn btn-edit" onclick="editATM('${atm.id}')">
                                <i class="fas fa-edit"></i>Edit
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteATM('${atm.id}')">
                                <i class="fas fa-trash"></i>Delete
                            </button>
                        </div>
                    </div>
                `;
                
                atmList.appendChild(card);
            });
        }

        // Update Statistics
        function updateStatistics() {
            const total = atmData.length;
            const active = atmData.filter(atm => atm.status === 'aktif').length;
            const acWorking = atmData.filter(atm => atm.acStatus === 'baik').length;
            const needMaintenance = atmData.filter(atm => 
                atm.acStatus === 'perlu_service' || atm.acStatus === 'rusak'
            ).length;

            // Animate counter updates
            animateCounter('totalATM', total);
            animateCounter('activeATM', active);
            animateCounter('acWorking', acWorking);
            animateCounter('needMaintenance', needMaintenance);
        }

        // Animate Counter
        function animateCounter(id, target) {
            const element = document.getElementById(id);
            const current = parseInt(element.textContent);
            if (current === target) return;

            const increment = target > current ? 1 : -1;
            const step = Math.abs(target - current) / 10;
            
            let value = current;
            const timer = setInterval(() => {
                value += increment * Math.ceil(step);
                if ((increment > 0 && value >= target) || (increment < 0 && value <= target)) {
                    value = target;
                    clearInterval(timer);
                }
                element.textContent = value;
            }, 50);
        }

        // Update Charts
        function updateCharts() {
            if (document.getElementById('chartsSection').style.display === 'none') {
                return; // Don't update hidden charts
            }

            updateStatusChart();
            updateACChart();
            updateMaintenanceChart();
        }

        // Update Status Chart
        function updateStatusChart() {
            const ctx = document.getElementById('statusChart');
            if (!ctx) return;

            if (charts.status) {
                charts.status.destroy();
            }

            const statusData = {
                aktif: atmData.filter(a => a.status === 'aktif').length,
                maintenance: atmData.filter(a => a.status === 'maintenance').length,
                tidak_aktif: atmData.filter(a => a.status === 'tidak_aktif').length
            };

            charts.status = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Active', 'Maintenance', 'Inactive'],
                    datasets: [{
                        data: [statusData.aktif, statusData.maintenance, statusData.tidak_aktif],
                        backgroundColor: [
                            '#99bb1c',
                            '#f6d365',
                            '#ff6b6b'
                        ],
                        borderColor: [
                            '#7a9516',
                            '#fda085',
                            '#ee5a24'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update AC Chart
        function updateACChart() {
            const ctx = document.getElementById('acChart');
            if (!ctx) return;

            if (charts.ac) {
                charts.ac.destroy();
            }

            const acData = {
                baik: atmData.filter(a => a.acStatus === 'baik').length,
                perlu_service: atmData.filter(a => a.acStatus === 'perlu_service').length,
                rusak: atmData.filter(a => a.acStatus === 'rusak').length
            };

            charts.ac = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Good', 'Need Service', 'Broken'],
                    datasets: [{
                        label: 'AC Count',
                        data: [acData.baik, acData.perlu_service, acData.rusak],
                        backgroundColor: [
                            'rgba(153, 187, 28, 0.8)',
                            'rgba(246, 211, 101, 0.8)',
                            'rgba(255, 107, 107, 0.8)'
                        ],
                        borderColor: [
                            '#99bb1c',
                            '#f6d365',
                            '#ff6b6b'
                        ],
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update Maintenance Chart
        function updateMaintenanceChart() {
            const ctx = document.getElementById('maintenanceChart');
            if (!ctx) return;

            if (charts.maintenance) {
                charts.maintenance.destroy();
            }

            // Generate sample maintenance data for the last 6 months
            const months = ['Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const maintenanceData = [];
            const currentMonth = new Date().getMonth();
            
            // Generate realistic maintenance data
            months.forEach((month, index) => {
                const totalHistory = atmData.reduce((acc, atm) => {
                    if (atm.history) {
                        return acc + atm.history.length;
                    }
                    return acc;
                }, 0);
                
                // Simulate monthly distribution
                const monthlyMaintenance = Math.floor(Math.random() * (totalHistory / 2)) + 1;
                maintenanceData.push(monthlyMaintenance);
            });

            charts.maintenance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Maintenance Count',
                        data: maintenanceData,
                        borderColor: '#023259',
                        backgroundColor: 'rgba(2, 50, 89, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#99bb1c',
                        pointBorderColor: '#7a9516',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Toggle Charts
        function toggleCharts() {
            const chartsSection = document.getElementById('chartsSection');
            const isVisible = chartsSection.style.display !== 'none';
            
            if (isVisible) {
                chartsSection.style.display = 'none';
                showToast('info', 'Charts hidden');
            } else {
                chartsSection.style.display = 'block';
                updateCharts();
                showToast('info', 'Charts displayed');
                
                // Scroll to charts
                setTimeout(() => {
                    chartsSection.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 100);
            }
        }

        // Set Active Navigation
        function setActiveNav(element, section) {
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item
            if (!element.classList.contains('add-btn')) {
                element.classList.add('active');
            }

            // Handle section-specific actions
            if (section === 'home') {
                document.getElementById('chartsSection').style.display = 'none';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Filter ATMs
        function filterATMs() {
            renderATMs();
        }

        // Open ATM Modal
        function openATMModal() {
            currentATMId = null;
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-university me-2"></i>Add New ATM';
            document.getElementById('atmForm').reset();
            const modal = new bootstrap.Modal(document.getElementById('atmModal'));
            modal.show();
        }

        // Edit ATM
        function editATM(id) {
            const atm = atmData.find(a => a.id === id);
            if (!atm) return;

            currentATMId = id;
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit ATM';
            
            // Fill form
            document.getElementById('atmId').value = atm.id;
            document.getElementById('atmName').value = atm.name;
            document.getElementById('atmAddress').value = atm.address;
            document.getElementById('atmStatus').value = atm.status;
            document.getElementById('acBrand').value = atm.acBrand || '';
            document.getElementById('acCapacity').value = atm.acCapacity || '';
            document.getElementById('acStatus').value = atm.acStatus;
            document.getElementById('acTemp').value = atm.acTemp;
            document.getElementById('lastTechnician').value = atm.lastTechnician || '';
            document.getElementById('acNotes').value = atm.acNotes || '';

            const modal = new bootstrap.Modal(document.getElementById('atmModal'));
            modal.show();
        }

        // Save ATM
        async function saveATM() {
            const form = document.getElementById('atmForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const saveBtn = document.querySelector('#atmModal .modal-footer .btn-primary');
            const originalText = saveBtn.textContent;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
            saveBtn.disabled = true;

            try {
                const formData = {
                    name: document.getElementById('atmName').value,
                    address: document.getElementById('atmAddress').value,
                    status: document.getElementById('atmStatus').value,
                    acBrand: document.getElementById('acBrand').value,
                    acCapacity: parseFloat(document.getElementById('acCapacity').value) || null,
                    acStatus: document.getElementById('acStatus').value,
                    acTemp: parseInt(document.getElementById('acTemp').value),
                    lastTechnician: document.getElementById('lastTechnician').value,
                    acNotes: document.getElementById('acNotes').value,
                    updatedAt: new Date().toISOString()
                };

                if (currentATMId) {
                    await window.updateDoc(window.doc(window.db, "atms", currentATMId), formData);
                    showToast('success', 'ATM updated successfully');
                } else {
                    formData.createdAt = new Date().toISOString();
                    formData.history = [];
                    await window.addDoc(window.collection(window.db, "atms"), formData);
                    showToast('success', 'New ATM added successfully');
                }

                const modal = bootstrap.Modal.getInstance(document.getElementById('atmModal'));
                modal.hide();

            } catch (error) {
                console.error("Error saving ATM:", error);
                showToast('error', 'Failed to save ATM');
            } finally {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }

        // Delete ATM
        async function deleteATM(id) {
            const atm = atmData.find(a => a.id === id);
            if (!atm) return;

            if (!confirm(`Are you sure you want to delete "${atm.name}"?\n\nThis action cannot be undone.`)) return;

            try {
                await window.deleteDoc(window.doc(window.db, "atms", id));
                showToast('success', 'ATM deleted successfully');
            } catch (error) {
                console.error("Error deleting ATM:", error);
                showToast('error', 'Failed to delete ATM');
            }
        }

        // View History
        function viewHistory(id) {
            const atm = atmData.find(a => a.id === id);
            if (!atm) return;

            currentATMId = id;
            document.querySelector('#historyModal .modal-title').innerHTML = 
                `<i class="fas fa-history me-2"></i>${atm.name.length > 20 ? atm.name.substring(0, 20) + '...' : atm.name}`;
            
            renderHistory(atm.history);
            
            const modal = new bootstrap.Modal(document.getElementById('historyModal'));
            modal.show();
        }

        // Render History
        function renderHistory(history) {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            if (!history || history.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-history" style="font-size: 32px; color: #cbd5e0; margin-bottom: 8px;"></i>
                        <p style="color: #718096; margin: 0;">No maintenance history</p>
                    </div>
                `;
                return;
            }

            const sortedHistory = [...history].reverse();
            
            sortedHistory.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                historyItem.innerHTML = `
                    <div class="history-meta">
                        <i class="fas fa-calendar me-1"></i>
                        ${new Date(item.date).toLocaleDateString('id-ID', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        })}
                        ${item.technician ? `• <i class="fas fa-user me-1"></i>${item.technician}` : ''}
                    </div>
                    <div class="history-content">
                        <div class="history-text">${item.entry}</div>
                        <button class="history-delete" onclick="deleteHistoryEntry(${history.length - 1 - index})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }

        // Add History Entry
        async function addHistoryEntry() {
            const entry = document.getElementById('newHistoryEntry').value.trim();
            const technician = document.getElementById('technicianName').value.trim();
            
            if (!entry || !currentATMId) {
                showToast('warning', 'Please fill in work description');
                return;
            }

            if (!technician) {
                showToast('warning', 'Please fill in technician name');
                return;
            }

            try {
                const atm = atmData.find(a => a.id === currentATMId);
                if (!atm) return;

                const newEntry = {
                    date: new Date().toISOString().split('T')[0],
                    entry: entry,
                    technician: technician
                };

                const updatedHistory = [...(atm.history || []), newEntry];
                
                await window.updateDoc(window.doc(window.db, "atms", currentATMId), {
                    history: updatedHistory,
                    lastTechnician: technician,
                    updatedAt: new Date().toISOString()
                });

                document.getElementById('newHistoryEntry').value = '';
                document.getElementById('technicianName').value = '';
                showToast('success', 'History added successfully');
                
                atm.history = updatedHistory;
                renderHistory(atm.history);

            } catch (error) {
                console.error("Error adding history:", error);
                showToast('error', 'Failed to add history');
            }
        }

        // Delete History Entry
        async function deleteHistoryEntry(index) {
            if (!confirm('Delete this history entry?')) return;

            try {
                const atm = atmData.find(a => a.id === currentATMId);
                if (!atm || !atm.history) return;

                const updatedHistory = [...atm.history];
                updatedHistory.splice(index, 1);

                await window.updateDoc(window.doc(window.db, "atms", currentATMId), {
                    history: updatedHistory,
                    updatedAt: new Date().toISOString()
                });

                showToast('success', 'History deleted');
                
                atm.history = updatedHistory;
                renderHistory(atm.history);

            } catch (error) {
                console.error("Error deleting history:", error);
                showToast('error', 'Failed to delete history');
            }
        }

        // Toggle Dark Mode
        function toggleDarkMode() {
            darkMode = !darkMode;
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('darkModeIcon');
            icon.className = darkMode ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('darkMode', darkMode);
            
            // Update charts for dark mode
            if (document.getElementById('chartsSection').style.display !== 'none') {
                updateCharts();
            }
        }

        // Show Settings
        function showSettings() {
            const options = [
                '🌙 Toggle Dark Mode',
                '📊 Show Charts',
                '📱 About App',
                '🔄 Refresh Data'
            ];
            
            let choice = prompt('Settings:\n\n' + options.map((opt, i) => `${i+1}. ${opt}`).join('\n') + '\n\nSelect option (1-4):');
            
            switch(choice) {
                case '1':
                    toggleDarkMode();
                    break;
                case '2':
                    toggleCharts();
                    break;
                case '3':
                    alert('ATM Manager v1.0\nBank Sulselbar\n\nDeveloped for mobile-first experience');
                    break;
                case '4':
                    location.reload();
                    break;
                default:
                    if (choice) showToast('warning', 'Invalid option selected');
            }
        }

        // Export Data
        function exportData() {
            if (atmData.length === 0) {
                showToast('warning', 'No data to export');
                return;
            }

            try {
                const csvData = atmData.map(atm => ({
                    'Name': atm.name,
                    'Address': atm.address.replace(/,/g, ';'),
                    'Status': atm.status,
                    'AC_Brand': atm.acBrand || '',
                    'AC_Capacity': atm.acCapacity || '',
                    'AC_Status': atm.acStatus,
                    'AC_Temperature': atm.acTemp || '',
                    'Last_Technician': atm.lastTechnician || '',
                    'History_Count': atm.history ? atm.history.length : 0
                }));

                const headers = Object.keys(csvData[0]);
                const csvContent = [
                    headers.join(','),
                    ...csvData.map(row => headers.map(header => `"${row[header]}"`).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `atm-data-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('success', 'Data exported successfully');
            } catch (error) {
                console.error('Export error:', error);
                showToast('error', 'Export failed');
            }
        }

        // Show Toast
        function showToast(type, message) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const iconMap = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            };

            toast.className = `custom-toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${iconMap[type]}"></i>
                </div>
                <div>
                    <strong>${type.charAt(0).toUpperCase() + type.slice(1)}</strong><br>
                    <span style="font-size: 12px;">${message}</span>
                </div>
            `;

            toastContainer.appendChild(toast);

            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideDown 0.3s ease reverse';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, 3000);

            // Allow manual dismiss by tapping
            toast.addEventListener('click', () => {
                toast.style.animation = 'slideDown 0.3s ease reverse';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            });
        }

        // Update Connection Status
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('firebaseStatus');
            const statusMap = {
                'syncing': { icon: 'fa-sync fa-spin', text: 'Syncing...' },
                'connected': { icon: 'fa-cloud-check', text: 'Connected' },
                'error': { icon: 'fa-cloud-exclamation', text: 'Error' }
            };

            const config = statusMap[status];
            statusElement.innerHTML = `<i class="fas ${config.icon} me-1"></i>${config.text}`;
        }

        // Update Last Update Time
        function updateLastUpdateTime() {
            const element = document.getElementById('lastUpdate');
            const now = new Date();
            const time = now.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            element.innerHTML = `<i class="fas fa-clock me-1"></i>${time}`;
        }

        // Handle online/offline status
        window.addEventListener('online', () => {
            showToast('success', 'Connection restored');
            updateConnectionStatus('connected');
        });

        window.addEventListener('offline', () => {
            showToast('warning', 'Connection lost');
            updateConnectionStatus('error');
        });

        // Prevent pull-to-refresh on mobile (optional)
        let startY = 0;
        document.body.addEventListener('touchstart', e => {
            startY = e.touches[0].clientY;
        }, { passive: true });

        document.body.addEventListener('touchmove', e => {
            const currentY = e.touches[0].clientY;
            if (startY < currentY && window.scrollY === 0) {
                // Only prevent if scrolling down at top of page
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
